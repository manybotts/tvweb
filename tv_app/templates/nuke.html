{% extends 'base.html' %}
{% block title %}Nuke ¬∑ Search & Purge{% endblock %}
{% block content %}
<div class="container" style="max-width:1100px;">
  <h1>Nuke ¬∑ Search & Purge</h1>

  {% if request.args.get('msg') %}
    <div class="alert alert-info" role="alert" style="margin:.5rem 0;">
      {{ request.args.get('msg') }}
    </div>
  {% endif %}

  {# --- 0. ADBLOCK ANALYTICS PANEL (NEW) --- #}
  {% if adblock_stats %}
  <div class="card" style="margin: 20px 0; padding: 20px; border: 1px solid #444; background: #111; color: #ddd; display: flex; align-items: center; justify-content: space-between;">
      <div>
        <h3 style="margin: 0; color: #fff; font-size: 1.2rem;"><i class="fas fa-shield-alt" style="color: #e74c3c;"></i> AdBlock Stats</h3>
        <small style="color: #888;">Live tracking from Redis</small>
      </div>
      <div style="display: flex; gap: 30px; text-align: center;">
          <div>
              <div style="font-size: 2rem; font-weight: bold; color: #e74c3c;">{{ adblock_stats.detected }}</div>
              <div style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;">Detected</div>
          </div>
          <div>
              <div style="font-size: 2rem; font-weight: bold; color: #2ecc71;">{{ adblock_stats.resolved }}</div>
              <div style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;">Resolved</div>
          </div>
      </div>
  </div>
  {% endif %}

  {# --- 1. BACKFILL MATRIX PANEL --- #}
  <div class="card" style="margin: 20px 0; padding: 20px; border: 1px solid #444; background: #1a1a1a; color: #ddd;">
      <h3 style="margin-top:0; color: #fff;">üé¨ Movie Backfill Engine (Matrix Mode)</h3>
      
      {# Controls #}
      <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
          <button id="btn-start" class="btn" style="background: #27ae60; color: white; border: none; padding: 10px 20px; cursor: pointer;">‚ñ∂ Start Backfill</button>
          <button id="btn-pause" class="btn" style="background: #f39c12; color: white; border: none; padding: 10px 20px; cursor: pointer;">‚è∏ Pause</button>
          
          <div style="border-left: 1px solid #555; padding-left: 10px; display: flex; gap: 10px;">
              <button id="btn-reset" class="btn" style="background: #8e44ad; color: white; border: none; padding: 10px 15px; cursor: pointer;" onclick="return confirm('Reset Redis stats, LOGS, and checkpoints? This will make the backfill start over from the beginning.')">üîÑ Reset Memory</button>
              <button id="btn-purge" class="btn" style="background: #c0392b; color: white; border: none; padding: 10px 15px; cursor: pointer;" onclick="return confirm('‚ö†Ô∏è DANGER: This will delete ALL Movies and Skipped Files from the database. Are you sure?')">‚ò¢Ô∏è Purge All Movies</button>
          </div>
      </div>

      {# Live Status #}
      <div style="display: flex; gap: 20px; margin-bottom: 15px;">
        <div style="flex: 1; background: #000; padding: 10px; border-radius: 4px; font-family: monospace; border: 1px solid #333;">
            <div style="color: #2ecc71; font-weight: bold; margin-bottom: 5px;" id="backfill-state">State: Idle</div>
            <div style="color: #aaa;" id="backfill-current">Waiting for update...</div>
        </div>
        
        <div style="flex: 0 0 auto; display: flex; flex-direction: column; justify-content: center; gap: 5px; color: #aaa; font-size: 0.9em;">
             <span>Movies Added: <strong id="stat-added" style="color: #fff; font-size: 1.2em;">0</strong></span>
             <span>Files Scanned: <strong id="stat-progress" style="color: #fff; font-size: 1.2em;">0</strong></span>
        </div>
      </div>

      {# MATRIX TERMINAL WINDOW #}
      <div id="terminal-window" style="background: #000; border: 1px solid #333; height: 350px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 0.85em; margin-bottom: 15px; border-radius: 4px; display: flex; flex-direction: column-reverse;">
          <div style="color: #666; padding: 10px;">Waiting for logs...</div>
      </div>
  </div>

  <form method="get" action="{{ url_for('nuke_home') }}">
    <div style="display:flex;gap:.5rem;align-items:center;margin:.75rem 0;">
      <input type="text" name="q" value="{{ q or '' }}" placeholder="Search by title, episode, link or id:123" style="flex:1;padding:.5rem;">
      <button type="submit" class="btn">Search</button>
      {% if view_dupes %}
        <a class="btn" href="{{ url_for('nuke_home', q=q) }}">All results</a>
      {% else %}
        <a class="btn" href="{{ url_for('nuke_home', dupes=1, q=q) }}">Duplicate links</a>
      {% endif %}
    </div>
  </form>

  <form method="post" action="{{ url_for('nuke_logout') }}" style="margin:.5rem 0;">
    <button type="submit" class="btn">Logout</button>
  </form>

  {# --- 2. Existing Duplicates/Search Logic --- #}
  {% if view_dupes %}
    {% if dupe_groups|length == 0 %}
      <p>No duplicate download links found{{ ' for "' ~ q ~ '"' if q }}.</p>
    {% else %}
      {% for g in dupe_groups %}
        <h3 style="margin-top:1rem;">{{ g.domain or 'Unknown host' }} ¬∑ {{ g.shows|length }} entries</h3>
        <details style="margin-bottom:.5rem;"><summary style="cursor:pointer;opacity:.8;">{{ g.link }}</summary></details>

        <form method="post" action="{{ url_for('nuke_bulk_delete', q=q) }}" onsubmit="return confirm('Proceed with bulk delete?');">
          <input type="hidden" name="link" value="{{ g.link }}">
          <div style="display:flex;gap:.5rem;align-items:center;margin:.5rem 0;">
            <label style="display:flex;align-items:center;gap:.35rem;">
              <input type="checkbox" onclick="toggleWithinForm(this)"> Select all in group
            </label>
            <button type="submit" name="mode" value="selected" class="btn btn-danger">Delete selected</button>
            <button type="submit" name="mode" value="all_but_latest" class="btn btn-danger">Delete all but newest</button>
            <button type="submit" name="mode" value="all" class="btn btn-danger">Delete all in group</button>
          </div>

          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;">
            {% for s in g.shows %}
              <label class="card" style="padding:.5rem;border:1px solid #333;border-radius:.5rem;display:block;">
                <div style="display:flex;gap:10px;">
                  <input type="checkbox" name="ids" value="{{ s.id }}">
                  <img src="{{ s.poster_path or '' }}" alt="" style="width:70px;height:100px;object-fit:cover;border-radius:.25rem;">
                  <div style="flex:1;">
                    <div style="font-weight:600;">
                      <a href="{{ url_for('show_details', slug=s.slug) }}" target="_blank">{{ s.show_name }}</a>
                    </div>
                    <div style="opacity:.8;">{{ s.episode_title or '-' }}</div>
                    <div style="opacity:.6;font-size:.9em;">{{ s.created_at }}</div>
                    <div style="opacity:.6;font-size:.85em;">{{ s.download_link | hostonly }}</div>
                  </div>
                </div>
              </label>
            {% endfor %}
          </div>
        </form>
      {% endfor %}
    {% endif %}
  {% else %}
    {% if q and (not shows or (shows.items | length == 0)) %}<p>No results.</p>{% endif %}
    {% if shows and shows.items %}
    <table class="table" border="1" cellpadding="6" cellspacing="0" width="100%">
      <thead><tr><th>Poster</th><th>ID</th><th>Title</th><th>Episode</th><th>Created</th><th>Link Host</th><th>Actions</th></tr></thead>
      <tbody>
      {% for s in shows.items %}
        <tr>
          <td style="width:80px;"><img src="{{ s.poster_path or '' }}" alt="" style="width:60px;height:85px;object-fit:cover;border-radius:.25rem;"></td>
          <td>{{ s.id }}</td>
          <td><a href="{{ url_for('show_details', slug=s.slug) }}" target="_blank">{{ s.show_name }}</a></td>
          <td>{{ s.episode_title or '-' }}</td>
          <td>{{ (s.created_at or s.updated_at)|default('', true) }}</td>
          <td style="max-width:220px;word-break:break-all;">{% if s.download_link %}{{ s.download_link | hostonly }}{% else %}‚Äî{% endif %}</td>
          <td>
            <form method="post" action="{{ url_for('nuke_delete', show_id=s.id, q=q) }}" style="display:inline;" onsubmit="return confirm('Delete permanently?');">
              <button type="submit" class="btn btn-danger">Delete</button>
            </form>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
    {% endif %}
  {% endif %}

  {# --- 3. Skipped Files Log (Legacy/Database) --- #}
  {% if skipped_files %}
  <div style="margin-top: 50px; border-top: 1px solid #333; padding-top: 20px;">
      <h3>Skipped Files (Database Records)</h3>
      <table class="table" style="font-size: 0.85em; width: 100%; border-collapse: collapse;">
          <thead>
              <tr style="text-align:left; border-bottom: 1px solid #444;">
                  <th style="padding: 8px;">Filename</th>
                  <th style="padding: 8px;">Reason</th>
                  <th style="padding: 8px;">Time</th>
              </tr>
          </thead>
          <tbody>
              {% for skip in skipped_files %}
              <tr style="border-bottom: 1px solid #222;">
                  <td style="padding: 8px; word-break: break-all;">{{ skip.filename }}</td>
                  <td style="padding: 8px; color: #e74c3c;">{{ skip.reason }}</td>
                  <td style="padding: 8px;">{{ skip.created_at.strftime('%H:%M:%S') }}</td>
              </tr>
              {% endfor %}
          </tbody>
      </table>
  </div>
  {% endif %}

</div>

<script>
function toggleWithinForm(cb){
  const form = cb.closest('form'); if(!form) return;
  form.querySelectorAll('input[name="ids"]').forEach(x => x.checked = cb.checked);
}

// --- NEW: Backfill JS Logic with Reset/Purge ---
document.addEventListener('DOMContentLoaded', () => {
    const btnStart = document.getElementById('btn-start');
    const btnPause = document.getElementById('btn-pause');
    const btnReset = document.getElementById('btn-reset');
    const btnPurge = document.getElementById('btn-purge');
    
    const statusEl = document.getElementById('backfill-state');
    const currentEl = document.getElementById('backfill-current');
    const statAdded = document.getElementById('stat-added');
    const statProgress = document.getElementById('stat-progress');
    const terminal = document.getElementById('terminal-window');

    const apiCall = (url) => {
        fetch(url, {method: 'POST'})
            .then(r => r.json())
            .then(d => {
                if(d.message) alert(d.message);
                if(d.success) window.location.reload(); // Refresh to show changes
            })
            .catch(e => alert("Error: " + e));
    };

    if(btnStart) {
        btnStart.onclick = () => apiCall('/nuke/backfill/start');
        btnPause.onclick = () => apiCall('/nuke/backfill/pause');
        btnReset.onclick = () => apiCall('/nuke/backfill/reset');
        btnPurge.onclick = () => apiCall('/nuke/movies/purge');

        // Poll status every 1.5 seconds for matrix updates
        setInterval(() => {
            fetch('/nuke/backfill/status')
                .then(r => r.json())
                .then(data => {
                    if (data.state) statusEl.innerText = "State: " + data.state;
                    if (data.current_file) currentEl.innerText = data.current_file;
                    if (data.added) statAdded.innerText = data.added;
                    if (data.progress) statProgress.innerText = data.progress;

                    // Matrix Log Update (Color Coded)
                    if (data.logs && Array.isArray(data.logs) && data.logs.length > 0) {
                        terminal.innerHTML = data.logs.map(line => {
                            let color = '#ccc'; // Default
                            if (line.includes('‚úÖ')) color = '#2ecc71'; // Green
                            if (line.includes('‚ö†Ô∏è')) color = '#f1c40f'; // Yellow
                            if (line.includes('‚ôªÔ∏è')) color = '#3498db'; // Blue
                            if (line.includes('üì∫')) color = '#9b59b6'; // Purple (TV)
                            if (line.includes('Error') || line.includes('Fail')) color = '#e74c3c'; // Red
                            if (line.includes('Starting') || line.includes('Resuming')) color = '#fff'; // White
                            
                            return `<div style="color:${color}; margin-bottom:2px; line-height:1.2;">${line}</div>`;
                        }).join('');
                    }
                });
        }, 1500);
    }
});
</script>
{% endblock %}
