{% extends 'base.html' %}
{% block title %}Nuke Â· Search & Purge{% endblock %}
{% block content %}
<div class="container" style="max-width:1100px;">
  
  <div style="background:#222; padding:20px; border-radius:8px; margin-bottom:20px; border:1px solid #444;">
      <h3 style="margin-top:0; color:white;">ðŸš€ Movie Backfill Control</h3>
      <div style="display:flex; gap:10px; margin-bottom:15px;">
          <button onclick="controlBackfill('start')" style="background:#28a745; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;"><i class="fas fa-play"></i> Start</button>
          <button onclick="controlBackfill('pause')" style="background:#ffc107; color:black; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;"><i class="fas fa-pause"></i> Pause</button>
          <button onclick="controlBackfill('stop')" style="background:#dc3545; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;"><i class="fas fa-stop"></i> Stop</button>
          <button onclick="controlBackfill('reset')" style="background:#17a2b8; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer;"><i class="fas fa-undo"></i> Reset</button>
      </div>
      
      <div style="background:#111; padding:15px; border-radius:5px; font-family:monospace;">
          <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
              <span id="bf-state" style="font-weight:bold; color:#007bff;">IDLE</span>
              <span id="bf-counts" style="color:#aaa;">0 / 0</span>
          </div>
          <div style="width:100%; height:20px; background:#333; border-radius:10px; overflow:hidden; margin-bottom:10px;">
              <div id="bf-bar" style="width:0%; height:100%; background:#007bff; transition:width 0.5s ease;"></div>
          </div>
          <div style="color:#888; font-size:0.9em;">
              Processing: <span id="bf-current" style="color:#fff;">...</span><br>
              <span style="color:#28a745;">Added: <span id="bf-added">0</span></span> | 
              <span style="color:#ffc107;">Skipped: <span id="bf-skipped">0</span></span>
          </div>
      </div>
  </div>

  <div style="background:#1a1a1a; padding:20px; border-radius:8px; margin-bottom:30px; border:1px solid #444;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <h3 style="margin:0; color:#ffc107; font-size:1.2em;"><i class="fas fa-exclamation-triangle"></i> Skipped / Failed Files ({{ skipped_files|length }})</h3>
          <form method="post" action="{{ url_for('nuke_clear_skipped') }}" onsubmit="return confirm('Clear this log?');" style="margin:0;">
              <button type="submit" style="background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Clear Log</button>
          </form>
      </div>
      <div style="max-height:300px; overflow-y:auto; background:#000; border:1px solid #333; padding:10px;">
          {% if skipped_files %}
              <table style="width:100%; border-collapse:collapse; color:#ccc; font-family:monospace; font-size:0.9em;">
                  <thead>
                      <tr style="border-bottom:1px solid #444; color:#fff;">
                          <th style="text-align:left; padding:5px;">Reason</th>
                          <th style="text-align:left; padding:5px;">Filename</th>
                      </tr>
                  </thead>
                  <tbody>
                      {% for f in skipped_files %}
                      <tr style="border-bottom:1px solid #222;">
                          <td style="padding:5px; color:#ff6b6b; white-space:nowrap;">{{ f.reason }}</td>
                          <td style="padding:5px; user-select:all; cursor:text; word-break:break-all;">{{ f.filename }}</td>
                      </tr>
                      {% endfor %}
                  </tbody>
              </table>
          {% else %}
              <p style="color:#666; text-align:center; margin:10px 0;">No failed files logged yet.</p>
          {% endif %}
      </div>
  </div>

  <script>
  function controlBackfill(a){fetch(`/nuke/backfill/${a}`,{method:'POST'}).then(r=>r.json()).then(updateStatus);}
  
  function updateStatus(){
      fetch('/nuke/backfill/status').then(r=>r.json()).then(d=>{
          const t=parseInt(d.total)||1,p=parseInt(d.progress)||0;
          document.getElementById('bf-state').innerText=(d.state||'IDLE').toUpperCase();
          document.getElementById('bf-counts').innerText=`${p} / ${t}`;
          document.getElementById('bf-bar').style.width=`${Math.round((p/t)*100)}%`;
          document.getElementById('bf-current').innerText=d.current||'...';
          document.getElementById('bf-added').innerText=d.added||0;
          document.getElementById('bf-skipped').innerText=d.skipped||0;
      });
  }
  
  // Auto-refresh status every 2 seconds
  setInterval(updateStatus, 2000);
  updateStatus();
  </script>

  <h1>Nuke Â· Search & Purge</h1>

  {% if request.args.get('msg') %}
    <div class="alert alert-info" role="alert" style="margin:.5rem 0;">
      {{ request.args.get('msg') }}
    </div>
  {% endif %}

  <form method="get" action="{{ url_for('nuke_home') }}">
    <div style="display:flex;gap:.5rem;align-items:center;margin:.75rem 0;">
      <input type="text" name="q" value="{{ q or '' }}" placeholder="Search by title, episode, link or id:123" style="flex:1;padding:.5rem;">
      <button type="submit" class="btn">Search</button>
      {% if view_dupes %}
        <a class="btn" href="{{ url_for('nuke_home', q=q) }}">All results</a>
      {% else %}
        <a class="btn" href="{{ url_for('nuke_home', dupes=1, q=q) }}">Duplicate links</a>
      {% endif %}
    </div>
  </form>

  <form method="post" action="{{ url_for('nuke_logout') }}" style="margin:.5rem 0;">
    <button type="submit" class="btn">Logout</button>
  </form>

  {% if view_dupes %}
    {% if dupe_groups|length == 0 %}
      <p>No duplicate download links found{{ ' for "' ~ q ~ '"' if q }}.</p>
    {% else %}
      {% for g in dupe_groups %}
        <h3 style="margin-top:1rem;">{{ g.domain or 'Unknown host' }} Â· {{ g.shows|length }} entries</h3>
        <details style="margin-bottom:.5rem;"><summary style="cursor:pointer;opacity:.8;">{{ g.link }}</summary></details>

        <form method="post" action="{{ url_for('nuke_bulk_delete', q=q) }}" onsubmit="return confirm('Proceed with bulk delete?');">
          <input type="hidden" name="link" value="{{ g.link }}">
          <div style="display:flex;gap:.5rem;align-items:center;margin:.5rem 0;">
            <label style="display:flex;align-items:center;gap:.35rem;">
              <input type="checkbox" onclick="toggleWithinForm(this)"> Select all in group
            </label>
            <button type="submit" name="mode" value="selected" class="btn btn-danger">Delete selected</button>
            <button type="submit" name="mode" value="all_but_latest" class="btn btn-danger">Delete all but newest</button>
            <button type="submit" name="mode" value="all" class="btn btn-danger">Delete all in group</button>
          </div>

          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;">
            {% for s in g.shows %}
              <label class="card" style="padding:.5rem;border:1px solid #333;border-radius:.5rem;display:block;">
                <div style="display:flex;gap:10px;">
                  <input type="checkbox" name="ids" value="{{ s.id }}">
                  <img src="{{ s.poster_path or '' }}" alt="" style="width:70px;height:100px;object-fit:cover;border-radius:.25rem;">
                  <div style="flex:1;">
                    <div style="font-weight:600;">
                      <a href="{{ url_for('show_details', slug=s.slug) }}" target="_blank">{{ s.show_name }}</a>
                    </div>
                    <div style="opacity:.8;">{{ s.episode_title or '-' }}</div>
                    <div style="opacity:.6;font-size:.9em;">{{ s.created_at }}</div>
                    <div style="opacity:.6;font-size:.85em;">{{ s.download_link | hostonly }}</div>
                  </div>
                </div>
              </label>
            {% endfor %}
          </div>
        </form>
      {% endfor %}
    {% endif %}
  {% else %}
    {% if q and (not shows or (shows.items | length == 0)) %}<p>No results.</p>{% endif %}
    {% if shows and shows.items %}
    <table class="table" border="1" cellpadding="6" cellspacing="0" width="100%">
      <thead><tr><th>Poster</th><th>ID</th><th>Title</th><th>Episode</th><th>Created</th><th>Link Host</th><th>Actions</th></tr></thead>
      <tbody>
      {% for s in shows.items %}
        <tr>
          <td style="width:80px;"><img src="{{ s.poster_path or '' }}" alt="" style="width:60px;height:85px;object-fit:cover;border-radius:.25rem;"></td>
          <td>{{ s.id }}</td>
          <td><a href="{{ url_for('show_details', slug=s.slug) }}" target="_blank">{{ s.show_name }}</a></td>
          <td>{{ s.episode_title or '-' }}</td>
          <td>{{ (s.created_at or s.updated_at)|default('', true) }}</td>
          <td style="max-width:220px;word-break:break-all;">{% if s.download_link %}{{ s.download_link | hostonly }}{% else %}â€”{% endif %}</td>
          <td>
            <form method="post" action="{{ url_for('nuke_delete', show_id=s.id, q=q) }}" style="display:inline;" onsubmit="return confirm('Delete permanently?');">
              <button type="submit" class="btn btn-danger">Delete</button>
            </form>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
    {% endif %}
  {% endif %}
</div>
<script>
function toggleWithinForm(cb){
  const form = cb.closest('form'); if(!form) return;
  form.querySelectorAll('input[name="ids"]').forEach(x => x.checked = cb.checked);
}
</script>
{% endblock %}
